<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShonenMaster - Panel Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FFD700;
            --primary-dark: #FFA500;
            --bg-main: #0a0e27;
            --bg-card: #141b34;
            --bg-card-hover: #1a2342;
            --text-primary: #ffffff;
            --text-secondary: #a0a8c0;
            --success: #00ff88;
            --danger: #ff4757;
            --warning: #ffa502;
            --border: #1e2847;
            --shadow: rgba(255, 215, 0, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 165, 0, 0.03) 0%, transparent 50%);
        }

        /* ============ LOGIN ============ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .login-box {
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 16px;
            padding: 40px 32px;
            max-width: 360px;
            width: 100%;
            box-shadow: 0 8.0px 32px rgba(0, 0, 0, 0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo h1 {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6.4px;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 0.72rem;
        }

        .form-group {
            margin-bottom: 19px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6.4px;
            color: var(--text-secondary);
            font-size: 0.72rem;
            font-weight: 500;
        }

        .form-group input {
            text-align: center;
            width: 100%;
            padding: 11px 14px;
            background: var(--bg-main);
            border: 1.6px solid var(--border);
            border-radius: 9.6px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2.4px rgba(255, 215, 0, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 11px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--bg-main);
            border: none;
            border-radius: 9.6px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-1.6px);
            box-shadow: 0 6.4px 16px var(--shadow);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .error-msg {
            color: var(--danger);
            text-align: center;
            margin-top: 13px;
            font-size: 0.72rem;
        }

        /* ============ ADMIN PANEL ============ */
        .admin-panel {
            display: none;
            min-height: 100vh;
        }

        /* Header avec titre + status */
        .admin-header {
            background: var(--bg-card);
            border-bottom: 0.8px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8.0px);
        }

        .admin-header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 9.6px;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6.4px;
            padding: 6.4px 13px;
            background: var(--bg-main);
            border-radius: 16px;
            font-size: 0.68rem;
            font-weight: 500;
        }

        .status-dot {
            width: 6.4px;
            height: 6.4px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 8.0px var(--success);
        }

        .status-dot.inactive {
            background: var(--danger);
            box-shadow: 0 0 8.0px var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-icon {
            padding: 8.0px 11px;
            background: var(--bg-main);
            border: 0.8px solid var(--border);
            border-radius: 8.0px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.88rem;
        }

        .btn-icon:hover {
            border-color: var(--primary);
            transform: translateY(-1.6px);
        }

        /* ============ BOUTONS CONTRÔLE (VERTICAL) ============ */
        .control-buttons-vertical {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        /* ============ BOUTONS CONTRÔLE (100% WIDTH - LEGACY) ============ */
        .control-buttons {
            padding: 16px 24px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            border-bottom: 0.8px solid var(--border);
        }

        .control-card {
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 13px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .control-card:hover:not(.disabled) {
            transform: translateY(-3.2px);
            border-color: var(--primary);
            box-shadow: 0 6.4px 16px var(--shadow);
        }

        .control-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .control-card.timer-blocked {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
            border-color: var(--warning) !important;
            background: linear-gradient(135deg, rgba(255, 165, 2, 0.1) 0%, rgba(255, 165, 2, 0.05) 100%) !important;
        }

        .control-card.timer-blocked h3 {
            color: var(--warning) !important;
        }

        .control-card.timer-blocked h3::after {
            content: ' ⏱';
            animation: pulse-timer 1s ease-in-out infinite;
        }

        @keyframes pulse-timer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .control-card.lobby-active {
            border-color: var(--success) !important;
            border-width: 1.6px !important;
            border-style: solid !important;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.05) 100%) !important;
            box-shadow: 0 0 16px rgba(0, 255, 136, 0.2) !important;
        }

        .control-card.lobby-active h3 {
            color: var(--success) !important;
        }

        .control-card.game-active {
            border-color: var(--primary);
            border-width: 1.6px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%);
            box-shadow: 0 0 16px rgba(255, 215, 0, 0.2);
        }

        .control-card.game-active h3 {
            color: var(--primary);
        }

        .control-card h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-card.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
        }

        .control-card.primary h3 {
            color: var(--bg-main);
        }

        .control-card.danger h3 {
            color: var(--danger);
        }

        .control-card.secondary h3 {
            color: var(--text-secondary);
        }

        /* ============ LAYOUT 30/70 ============ */
        .admin-content {
            display: grid;
            grid-template-columns: 25% 50% 25%;
            min-height: calc(100vh - 160px);
        }

        /* ============ LEFT SIDE (Stats) ============ */
        .left-panel {
            padding: 24px;
            border-right: 0.8px solid var(--border);
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 0.8px solid var(--border);
            border-radius: 9.6px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 6.4px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stat-value .status-dot {
            width: 16px;
            height: 16px;
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-value.danger {
            color: var(--danger);
        }

        /* Toggle Buttons */
        .toggle-buttons {
            display: flex;
            gap: 9.6px;
            margin-bottom: 16px;
        }

        .toggle-btn {
            flex: 1;
            padding: 9.6px 16px;
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 9.6px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            border-color: var(--primary);
            transform: translateY(-1.6px);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--bg-main);
            border: none;
        }

        /* Overlays pour Top 10 et Recent Games */
        .overlay-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 35%;
            height: 100vh;
            background: var(--bg-main);
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            border-right: 0.8px solid var(--border);
        }

        .overlay-panel.active {
            transform: translateX(0);
        }

        .overlay-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 199;
        }

        .overlay-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .overlay-header h2 {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .close-overlay {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4.0px 8.0px;
            transition: all 0.3s ease;
        }

        .close-overlay:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        /* Tables */
        .data-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 9.6px;
            overflow: hidden;
            border: 0.8px solid var(--border);
        }

        .data-table thead {
            background: var(--bg-main);
        }

        .data-table th {
            padding: 8px 10px;
            text-align: left;
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px;
            border-top: 0.8px solid var(--border);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: var(--bg-card-hover);
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            font-weight: 700;
            font-size: 0.65rem;
        }

        .rank-badge.rank-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: var(--bg-main);
        }

        .rank-badge.rank-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
            color: var(--bg-main);
        }

        .rank-badge.rank-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
            color: white;
        }

        .rank-badge:not(.rank-1):not(.rank-2):not(.rank-3) {
            background: var(--bg-main);
            color: var(--text-secondary);
        }

        /* ============ RIGHT SIDE (Question/Players) ============ */
        
        .admin-grid {
            display: grid;
            grid-template-columns: 280px 1fr 200px; /* Panneau droit réduit à 200px pour plus d'espace au centre */
            gap: 16px;
            padding: 20px;
            max-height: calc(100vh - 80px); /* Hauteur max pour éviter scroll */
            overflow: hidden;
        }

        /* Panneau latéral droit optimisé */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 14px; /* Réduire l'espace entre sections */
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            padding-right: 8px;
        }

        /* Réduire les paddings des cards */
        .settings-card,
        .database-card {
            padding: 16px; /* Réduire de 24px à 16px */
        }

        /* Réduire l'espacement dans les sections */
        .settings-section,
        .database-section {
            margin-bottom: 16px; /* Réduire de 24px à 16px */
        }

        .settings-section:last-child,
        .database-section:last-child {
            margin-bottom: 0;
        }

        /* Optimiser les stat-items pour prendre moins de place */
        .db-stat-item {
            padding: 10px 12px; /* Réduire padding */
            margin-bottom: 8px; /* Réduire marge */
        }

        .db-stat-label {
            font-size: 0.7rem; /* Réduire de 0.75rem */
        }

        /* Scrollbar personnalisée pour le panneau droit */
        .right-panel::-webkit-scrollbar {
            width: 6px;
        }

        .right-panel::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 10px;
        }

        .right-panel::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .right-panel::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* STYLES POUR LE PANNEAU DE DROITE */

        /* ============ SETTINGS PANEL (RIGHT) ============ */
                .settings-panel {
            padding: 12px;
            border-left: 0.8px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .settings-panel {
            padding: 12px;
            border-left: 0.8px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .settings-panel::-webkit-scrollbar {
            width: 4px;
        }

        .settings-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .settings-panel::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .settings-panel::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

                /* Settings Section */
        .settings-section {
            background: var(--bg-card);
            border: 0.8px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .settings-section h3 {
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

                .setting-item {
            margin-bottom: 14px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }

        /* Lives Selector */
        .lives-selector {
            display: flex;
            gap: 10px;
        }

        .lives-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-main);
            border: 1.6px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lives-btn:hover:not(.active):not(:disabled) {
            border-color: var(--primary);
            background: rgba(255, 215, 0, 0.05);
        }

        .lives-btn.active {
            background: var(--primary);
            color: var(--bg-main);
            border-color: var(--primary);
        }

        .lives-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Time Selector */
        .time-selector {
            position: relative;
        }

        .time-select {
            width: 100%;
            padding: 10px;
            background: var(--bg-main);
            border: 1.6px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-select:hover:not(:disabled) {
            border-color: var(--primary);
        }

        .time-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Database Stats */
                .db-stats {
            background: var(--bg-card);
            border: 0.8px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .db-stats h3 {
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

                .db-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .db-stat-item:first-child {
            padding-top: 0;
        }

        .db-stat-item:last-child {
            padding-bottom: 0;
            border-bottom: none;
        }

                .db-stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .db-stat-value {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 700;
        }

        /* Disabled state for settings during game */
        .settings-section.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Tabs */
        .tabs-header {
            display: flex;
            gap: 8.0px;
            margin-bottom: 16px;
            border-bottom: 1.6px solid var(--border);
        }

        .tab-btn {
            padding: 9.6px 19px;
            background: transparent;
            border: none;
            border-bottom: 2.4px solid transparent;
            color: var(--text-secondary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.76rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: -1.6px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            flex: 1;
        }

        .tab-content.active {
            display: block;
        }

        /* ============ QUESTION TAB ============ */
        .question-display {
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 13px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .question-meta {
            display: flex;
            gap: 8.0px;
            margin-bottom: 12px;
        }

        .meta-badge {
            padding: 4.8px 11px;
            border-radius: 16px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .meta-badge.serie {
            background: var(--bg-main);
            color: var(--primary);
            border: 0.8px solid var(--primary);
        }

        .meta-badge.difficulty {
            background: var(--warning);
            color: var(--bg-main);
        }

        .meta-badge.difficulty.facile {
            background: var(--success);
        }

        .meta-badge.difficulty.difficile {
            background: var(--danger);
        }

        .question-text {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 14px;
            line-height: 1.4;
        }

        /* Timer Barre Horizontale */
        .timer-bar-container {
            margin-bottom: 14px;
        }

        .timer-bar-wrapper {
            width: 100%;
            height: 9.6px;
            background: var(--bg-main);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 0.8px solid var(--border);
        }

        .timer-bar-fill {
            height: 100%;
            background: #4a5568;
            transition: width 0.1s linear;
            border-radius: 16px;
        }

        .timer-bar-fill.warning {
            background: var(--danger);
            animation: blink 0.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .timer-text {
            text-align: center;
            margin-top: 6.4px;
            font-size: 0.96rem;
            font-weight: 700;
            color: var(--primary);
        }

        .timer-text.warning {
            color: var(--danger);
        }

        /* Answers List */
        .answers-list {
            display: flex;
            flex-direction: column;
            gap: 8.0px;
        }

        .answer-item {
            display: flex;
            align-items: center;
            gap: 9.6px;
            padding: 9.6px 13px;
            background: var(--bg-main);
            border: 0.8px solid var(--border);
            border-radius: 9.6px;
            transition: all 0.3s ease;
        }

        .answer-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            background: var(--primary);
            color: var(--bg-main);
            border-radius: 6.4px;
            font-weight: 700;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .answer-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.76rem;
        }

        /* Results Display */
        .results-display {
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 13px;
            padding: 24px;
            animation: slideInUp 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-display h3 {
            font-size: 1.0rem;
            color: var(--primary);
            margin-bottom: 14px;
            text-align: center;
        }
        
        .results-question-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
            margin-bottom: 14px;
            text-align: center;
            line-height: 1.4;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
            padding: 0 12px;
        }

        .chart-box {
            height: 320px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-main);
            border: 1.6px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            animation: fadeIn 0.6s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .chart-box:nth-child(2) {
            animation-delay: 0.2s;
        }

        .chart-title {
            font-size: 0.88rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .chart-svg {
            max-height: 180px;
            width: 100%;
            max-width: 210px;
            aspect-ratio: 1;
            margin: 0 auto;
            display: block;
            overflow: visible !important;
        }

        /* Chart with legend layout */
        .chart-with-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex: 1; /* 🆕 Prendre l'espace disponible */
            min-height: 0; /* 🆕 Important pour flexbox */
            overflow: hidden; /* 🆕 Empêcher débordement */
        }

        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 4px; /* 🆕 Réduit de 8px à 4px */
            min-width: 90px; /* 🆕 Réduit de 110px à 90px */
            max-height: 220px; /* 🆕 Limite hauteur légende */
            overflow-y: auto; /* 🆕 Scroll si trop d'items */
        }

        /* 🆕 Scrollbar légende */
        .chart-legend::-webkit-scrollbar {
            width: 4px;
        }

        .chart-legend::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.68rem;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-label {
            color: var(--text-primary);
            flex: 1;
            font-size: 0.75rem;
        }

        .legend-value {
            color: var(--text-primary);
            font-weight: 600;
            min-width: 20px;
            text-align: right;
        }

        /* Fastest Player */
        .fastest-player {
            background: var(--bg-card);
            border: 0.8px solid var(--border);
            border-radius: 6.4px;
            padding: 8px 12px;
            text-align: center;
            color: var(--text-primary);
            margin-top: 8px;
            font-size: 0.68rem;
        }

        .fastest-player h4 {
            display: inline;
            font-size: 0.68rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-right: 6.4px;
        }

        .fastest-player-name {
            display: inline;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0 4.8px;
        }

        .fastest-player-time {
            display: inline;
            font-size: 0.68rem;
            font-weight: 500;
            color: var(--success);
        }

        /* ============ PLAYERS GRID TAB ============ */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(224px, 1fr));
            gap: 12px;
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            padding-right: 8.0px;
        }

        .players-grid::-webkit-scrollbar {
            width: 6.4px;
        }

        .players-grid::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 8.0px;
        }

        .players-grid::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 8.0px;
        }

        .players-grid::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .player-card {
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 9.6px;
            padding: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3.2px;
            background: var(--border);
            transition: all 0.3s ease;
        }

        .player-card.correct::before {
            background: var(--success);
        }

        .player-card.wrong::before {
            background: var(--danger);
        }

        .player-card.eliminated {
            opacity: 0.5;
        }

        .player-card:hover:not(.eliminated) {
            transform: translateY(-3.2px);
            border-color: var(--primary);
            box-shadow: 0 6.4px 16px var(--shadow);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-username {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .player-status {
            display: flex;
            align-items: center;
            gap: 6.4px;
        }

        .status-indicator {
            width: 8.0px;
            height: 8.0px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-indicator.correct {
            background: var(--success);
            box-shadow: 0 0 8.0px var(--success);
        }

        .status-indicator.wrong {
            background: var(--danger);
            box-shadow: 0 0 8.0px var(--danger);
        }

        .player-lives {
            display: flex;
            gap: 4.8px;
            align-items: center;
        }

        .player-lives span {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-right: 3.2px;
        }

        .heart-icon {
            font-size: 0.96rem;
        }

        .heart-icon.active {
            color: var(--danger);
            filter: drop-shadow(0 0 3.2px var(--danger));
        }

        .heart-icon.lost {
            color: var(--border);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 2.4rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 0.96rem;
            margin-bottom: 6.4px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 0.72rem;
        }

        /* Responsive */
        @media (max-width: 1120px) {
            .control-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 819px) {
            .admin-content {
                grid-template-columns: 1fr;
            }

            .left-panel {
                border-right: none;
                border-bottom: 0.8px solid var(--border);
            }

            .overlay-panel {
                width: 80%;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(192px, 1fr));
            }
        }

        @media (max-width: 614px) {
            .control-buttons {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .overlay-panel {
                width: 100%;
            }
        }

        /* ============ GAME END PANEL ============ */
        .game-end-panel {
            background: var(--bg-card);
            border: 1.6px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            animation: slideInUp 0.6s ease;
        }

        .game-end-header {
            margin-bottom: 16px;
        }

        .trophy-icon {
            font-size: 3.2rem;
            margin-bottom: 12px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8.0px); }
        }

        .game-end-header h2 {
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .winner-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.05) 100%);
            border: 1.6px solid var(--primary);
            border-radius: 13px;
            padding: 16px;
            margin: 16px 0;
        }

        .winner-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--bg-main);
            padding: 4.8px 13px;
            border-radius: 16px;
            font-size: 0.64rem;
            font-weight: 700;
            letter-spacing: 0.8px;
            margin-bottom: 9.6px;
        }

        .winner-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 14px;
            text-shadow: 0 0 16px rgba(255, 215, 0, 0.3);
        }

        .winner-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 12px;
        }

        .winner-stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-bottom: 4.8px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.hearts {
            font-size: 1.2rem;
            letter-spacing: 2.4px;
        }

        .stat-divider {
            width: 1.6px;
            height: 32px;
            background: var(--border);
        }

        .game-summary {
            display: flex;
            justify-content: center;
            gap: 28px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 0.8px solid var(--border);
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 4.8px;
            text-align: center;
        }

        .summary-label {
            font-size: 0.68rem;
            color: var(--text-secondary);
        }

        .summary-value {
            font-size: 0.96rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .game-end-icon {
            font-size: 3.2rem;
            margin-bottom: 16px;
        }

        /* ============================================ */
        /* RESPONSIVE DESIGN */
        /* ============================================ */

        @media (max-width: 1400px) {
            .admin-grid {
                grid-template-columns: 200px 1fr 200px;
                gap: 12px;
                padding: 16px;
            }
        }

        @media (max-width: 1200px) {
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .left-panel,
            .right-panel,
            .settings-panel {
                max-height: none;
                border-left: none;
                border-top: 0.8px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .settings-panel,
            .settings-section,
            .db-stats {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ============ LOGIN ============ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">
                <h1>ShonenMaster Admin</h1>
                <p>Panel d'administration</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Code d'accès</label>
                    <input type="password" id="adminCode" placeholder="Entrez le code admin" required autofocus>
                </div>
                <button type="submit" class="btn-login">Se connecter</button>
                <div class="error-msg" id="errorMsg"></div>
            </form>
        </div>
    </div>

    <!-- ============ ADMIN PANEL ============ -->
    <div class="admin-panel" id="adminPanel">
        <!-- Header -->
        <div class="admin-header">
            <h1>ShonenMaster Admin</h1>
            <div class="header-actions">
                <div class="status-badge">
                    <div class="status-dot inactive" id="statusIndicator"></div>
                    <span id="statusText">INACTIF</span>
                </div>
            </div>
        </div>

        <!-- Boutons de contrôle (100% width) -->
        <div class="control-buttons">
            <div class="control-card primary" id="toggleGameCard" onclick="toggleGame()">
                <h3 id="toggleGameBtn">Ouvrir lobby</h3>
            </div>
            <div class="control-card" id="startGameCard" onclick="startGame()">
                <h3>Démarrer la partie</h3>
            </div>
            <div class="control-card" id="nextQuestionCard" onclick="nextQuestion()">
                <h3>Question suivante</h3>
            </div>
            <div class="control-card secondary" onclick="refreshPage()">
                <h3>Rafraîchir</h3>
            </div>
        </div>

        <!-- Layout 30/70 -->
        <div class="admin-content">
            <!-- ============ LEFT PANEL (Stats + Controls) ============ -->
            <div class="left-panel">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Lobby</div>
                        <div class="stat-value" id="playerCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Actifs</div>
                        <div class="stat-value success" id="activePlayers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Question</div>
                        <div class="stat-value" id="currentQuestion">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Parties totales</div>
                        <div class="stat-value" id="totalGames">0</div>
                    </div>
                </div>

                <!-- Toggle Buttons -->
                <div class="toggle-buttons">
                    <button class="toggle-btn" onclick="toggleOverlay('top10')">
                        🏆 Top 10 Joueurs
                    </button>
                    <button class="toggle-btn" onclick="toggleOverlay('recent')">
                        📊 Parties récentes
                    </button>
                </div>
            </div>

            <!-- ============ RIGHT PANEL (Question/Players) ============ -->
            <div class="right-panel">
                <!-- Tabs -->
                <div class="tabs-header">
                    <button class="tab-btn active" onclick="switchTab('question')">
                        Question en cours
                    </button>
                    <button class="tab-btn" onclick="switchTab('players')">
                        Grille joueurs
                    </button>
                </div>

                <!-- Tab: Question -->
                <div class="tab-content active" id="tabQuestion">
                    <div id="questionContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">❓</div>
                            <h3>Aucune question active</h3>
                            <p>Démarrez une partie pour afficher les questions</p>
                        </div>
                    </div>
                    <div id="resultsContainer" style="display: none;">
                        <!-- Results will be injected here -->
                    </div>
                </div>

                <!-- Tab: Players Grid -->
                <div class="tab-content" id="tabPlayers">
                    <div class="players-grid" id="playersGrid">
                        <div class="empty-state">
                            <div class="empty-state-icon">👥</div>
                            <h3>Aucun joueur</h3>
                            <p>Les joueurs apparaîtront ici une fois la partie lancée</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============ SETTINGS PANEL (RIGHT) ============ -->
            <div class="settings-panel">
                <!-- Paramètres de partie -->
                <div class="settings-section" id="gameSettings">
                    <h3>Paramètres</h3>
                    
                    <div class="setting-item">
                        <label class="setting-label">Nombre de vies</label>
                        <div class="lives-selector">
                            <button class="lives-btn" onclick="setLives(1)" id="lives-1">1</button>
                            <button class="lives-btn" onclick="setLives(2)" id="lives-2">2</button>
                            <button class="lives-btn active" onclick="setLives(3)" id="lives-3">3</button>
                        </div>
                    </div>

                    <div class="setting-item">
                        <label class="setting-label">Temps par question</label>
                        <div class="time-selector">
                            <select class="time-select" id="timeSelect" onchange="setTime(this.value)">
                                <option value="5">5 secondes</option>
                                <option value="6">6 secondes</option>
                                <option value="7" selected>7 secondes</option>
                                <option value="8">8 secondes</option>
                                <option value="9">9 secondes</option>
                                <option value="10">10 secondes</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-item">
                        <label class="setting-label">Nombre de réponses</label>
                        <div class="lives-selector">
                            <button class="lives-btn active" onclick="setAnswers(4)" id="answers-4">4</button>
                            <button class="lives-btn" onclick="setAnswers(6)" id="answers-6">6</button>
                        </div>
                    </div>
                </div>

                <!-- Stats Database -->
                <div class="db-stats">
                    <h3>DATAS</h3>
                    <div class="db-stat-item">
                        <span class="db-stat-label">Questions</span>
                        <span class="db-stat-value" id="dbTotalQuestions">-</span>
                    </div>
                    
                    <div class="db-stat-item">
                        <span class="db-stat-label">Séries</span>
                        <span class="db-stat-value" id="dbTotalSeries">-</span>
                    </div>
                </div>
            </div>
        </div>


        
    </div>

    <!-- Overlay Backdrop -->
    <div class="overlay-backdrop" id="overlayBackdrop" onclick="closeOverlays()"></div>

    <!-- Overlay: Top 10 -->
    <div class="overlay-panel" id="overlayTop10">
        <div class="overlay-header">
            <h2>🏆 Top 10 Joueurs</h2>
            <button class="close-overlay" onclick="closeOverlays()">✕</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Rang</th>
                    <th>Joueur</th>
                    <th>Victoires</th>
                    <th>Parties</th>
                </tr>
            </thead>
            <tbody id="topPlayersTable">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Aucune donnée disponible
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Overlay: Recent Games -->
    <div class="overlay-panel" id="overlayRecent">
        <div class="overlay-header">
            <h2>📊 Parties récentes</h2>
            <button class="close-overlay" onclick="closeOverlays()">✕</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Gagnant</th>
                    <th>Questions</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="recentGamesTable">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Aucune donnée disponible
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        let socket;
        let statsInterval;
        let currentQuestionData = null;
        let timerInterval = null;
        let timeRemaining = 10;
        let isReloading = false; // 🆕 Flag pour éviter les reloads multiples
        let isTogglingGame = false; // 🆕 Anti-spam toggle game
        let isStartingGame = false; // 🆕 Anti-spam start game
        let isNextQuestion = false; // 🆕 Anti-spam next question
        
        // 🆕 Game Settings
        let gameSettings = {
            lives: 3,
            timePerQuestion: 7
        };

        // ============ AUTH ============
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('adminCode').value;
            const errorMsg = document.getElementById('errorMsg');

            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    initSocket();
                    refreshStats();
                    startStatsRefresh();
                } else {
                    errorMsg.textContent = 'Code incorrect';
                }
            } catch (error) {
                errorMsg.textContent = 'Erreur de connexion';
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch('/admin/check', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.isAdmin) {
                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        initSocket();
                        refreshStats();
                        startStatsRefresh();
                        // BUG FIX 1 & 2: Restaurer l'état du jeu après refresh
                        await restoreGameState();
                    }
                }
            } catch (error) {
                console.log('Non authentifié');
            }
        }

        // BUG FIX 1 & 2: Restaurer l'état complet du jeu après refresh
        async function restoreGameState() {
            try {
                const response = await fetch('/game/state');
                const state = await response.json();
                
                console.log('🔄 Restauration état:', state);
                
                // BUG FIX 1: Restaurer la liste des joueurs
                if (state.players && state.players.length > 0) {
                    updatePlayersGrid(state.players);
                    console.log(`✅ ${state.players.length} joueurs restaurés`);
                }
                
                // BUG FIX 2: Restaurer la question en cours
                if (state.currentQuestion && state.inProgress) {
                    console.log('✅ Question en cours restaurée');
                    displayQuestion(state.currentQuestion, state.timeRemaining || 0);
                    
                    // Démarrer le timer avec le temps restant
                    if (state.timeRemaining > 0) {
                        startAdminTimer(state.timeRemaining);
                    }
                }
                
                // 🆕 BUG FIX 3: Désactiver les paramètres si partie en cours ou lobby actif
                if (state.inProgress) {
                    toggleSettingsAccess(false);
                    console.log('🔒 Paramètres désactivés (partie en cours)');
                } else {
                    toggleSettingsAccess(true);
                    console.log('🔓 Paramètres activés');
                }
                
                // 🆕 BUG FIX 4: Restaurer l'état visuel des paramètres (vies + temps)
                if (state.lives) {
                    gameSettings.lives = state.lives;
                    document.querySelectorAll('.lives-btn').forEach(btn => btn.classList.remove('active'));
                    const livesBtn = document.getElementById(`lives-${state.lives}`);
                    if (livesBtn) livesBtn.classList.add('active');
                    console.log(`✅ Paramètre vies restauré: ${state.lives}`);
                }
                
                if (state.questionTime) {
                    gameSettings.timePerQuestion = state.questionTime;
                    const timeSelect = document.getElementById('timeSelect');
                    if (timeSelect) timeSelect.value = state.questionTime;
                    console.log(`✅ Paramètre temps restauré: ${state.questionTime}s`);
                }
                
            } catch (error) {
                console.error('❌ Erreur restauration état:', error);
            }
        }

        // ============ SOCKET ============
        function initSocket() {
            socket = io();

            socket.on('new-question', (data) => {
                console.log('📩 Question reçue:', data);
                displayQuestion(data);
                hideResults();
            });

            socket.on('question-results', (data) => {
                console.log('📊 Résultats reçus:', data);
                displayResults(data);
            });

            socket.on('lobby-update', (data) => {
                console.log('👥 Mise à jour lobby:', data);
                if (data.players) {
                    updatePlayersGrid(data.players);
                }
                if (data.playerCount !== undefined) {
                    document.getElementById('playerCount').textContent = data.playerCount;
                    // 🆕 Ne plus mettre à jour activePlayers ici, refreshStats() s'en charge
                }
            });

            socket.on('game-started', (data) => {
                console.log('🎮 Partie démarrée:', data);
                toggleSettingsAccess(false); // 🆕 Désactiver les paramètres au démarrage
                refreshStats();
                // Afficher l'onglet grille joueurs automatiquement
                switchTab('players');
            });

            socket.on('game-ended', (data) => {
                console.log('🏁 Partie terminée:', data);
                clearInterval(timerInterval);
                hideResults(); // Cacher les résultats de question
                displayGameEnd(data); // Afficher le panel de fin
                refreshStats();
            });

            // 🆕 Reset grille quand le lobby est ouvert (nouveau lobby)
            socket.on('game-activated', () => {
                console.log('✅ Lobby ouvert - Reset grille et affichage');
                updatePlayersGrid([]); // Vider la grille
                resetQuestionDisplay(); // Reset l'affichage question + panel fin
                refreshStats();
            });

            // 🆕 Reset grille quand le lobby est fermé MAIS pas l'affichage (pour garder le panel de fin)
            socket.on('game-deactivated', () => {
                console.log('❌ Lobby fermé - Reset grille uniquement');
                updatePlayersGrid([]); // Vider la grille
                // ⚠️ NE PAS appeler resetQuestionDisplay() ici pour garder le panel de fin
                refreshStats();
                toggleSettingsAccess(true); // 🆕 Réactiver les paramètres
            });
        }

        // ============ DISPLAY QUESTION ============
        function displayQuestion(data, initialTimeRemaining = null) {
            currentQuestionData = data;
            console.log("📝 Displaying question:", data);
            const container = document.getElementById('questionContainer');
            
            // Reset timer
            clearInterval(timerInterval);
            // BUG FIX 2: Utiliser le temps restant passé en paramètre si disponible
            timeRemaining = initialTimeRemaining !== null ? initialTimeRemaining : data.timeLimit;

            container.innerHTML = `
                <div class="question-display">
                    <div class="question-meta">
                        <span class="meta-badge serie">${data.serie}</span>
                        <span class="meta-badge difficulty ${data.difficulty}">${data.difficulty.toUpperCase()}</span>
                    </div>
                    
                    <h3 class="question-text">${data.question}</h3>
                    
                    <div class="timer-bar-container">
                        <div class="timer-bar-wrapper">
                            <div class="timer-bar-fill" id="timerBarFill"></div>
                        </div>
                        <div class="timer-text" id="timerText">${timeRemaining}s</div>
                    </div>
                    
                    <div class="answers-list">
                        ${data.answers.map((answer, index) => `
                            <div class="answer-item">
                                <div class="answer-number">${index + 1}</div>
                                <div class="answer-text">${answer}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // BUG FIX 2: Start timer seulement si timeRemaining > 0
            if (timeRemaining > 0) {
                startTimer(data.timeLimit);
            } else {
                // Timer déjà écoulé
                const fill = document.getElementById('timerBarFill');
                const text = document.getElementById('timerText');
                if (fill) fill.style.width = '0%';
                if (text) {
                    text.textContent = '0s';
                    text.classList.add('warning');
                }
            }

            // Update question number
            document.getElementById('currentQuestion').textContent = data.questionNumber;
            
            // S'assurer que le container est visible
            document.getElementById('resultsContainer').style.display = 'none';
            container.style.display = 'block';
        }

        function startTimer(duration) {
            const fill = document.getElementById('timerBarFill');
            const text = document.getElementById('timerText');
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                const percentage = (timeRemaining / duration) * 100;
                fill.style.width = percentage + '%';
                text.textContent = timeRemaining + 's';

                if (timeRemaining <= 3) {
                    fill.classList.add('warning');
                    text.classList.add('warning');
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        // BUG FIX 2: Timer spécifique pour la restauration après refresh
        function startAdminTimer(initialTime) {
            // Ne pas démarrer si le timer est presque fini (< 1 seconde)
            if (initialTime < 1) {
                console.log('⚠️ Timer trop court, pas de démarrage');
                return;
            }
            
            const fill = document.getElementById('timerBarFill');
            const text = document.getElementById('timerText');
            const duration = 7; // Durée totale de base
            
            if (!fill || !text) {
                console.log('⚠️ Éléments timer non trouvés');
                return;
            }
            
            // Définir l'état initial du timer
            timeRemaining = initialTime;
            const percentage = (timeRemaining / duration) * 100;
            fill.style.width = percentage + '%';
            text.textContent = timeRemaining + 's';
            
            if (timeRemaining <= 3) {
                fill.classList.add('warning');
                text.classList.add('warning');
            }
            
            // Démarrer l'intervalle
            clearInterval(timerInterval); // Clear any existing interval
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                const newPercentage = (timeRemaining / duration) * 100;
                fill.style.width = newPercentage + '%';
                text.textContent = timeRemaining + 's';

                if (timeRemaining <= 3) {
                    fill.classList.add('warning');
                    text.classList.add('warning');
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    console.log('⏱️ Timer terminé après restauration');
                }
            }, 1000);
            
            console.log(`✅ Timer démarré avec ${initialTime}s restantes`);
        }

        // ============ DISPLAY RESULTS ============
        function displayResults(data) {
            console.log('📊 displayResults appelé avec:', data);
            clearInterval(timerInterval);
            
            const container = document.getElementById('resultsContainer');
            console.log('📦 Container resultsContainer:', container);
            
            // Utiliser les bonnes propriétés du serveur
            const correctCount = data.stats.correct;
            const wrongCount = data.stats.wrong;
            const afkCount = data.stats.afk;
            const totalAnswers = correctCount + wrongCount + afkCount;
            
            console.log('📈 Stats:', { correctCount, wrongCount, afkCount, totalAnswers });

            // Diagramme 2: Répartition des vies
            const lives3 = data.stats.livesDistribution[3] || 0;
            const lives2 = data.stats.livesDistribution[2] || 0;
            const lives1 = data.stats.livesDistribution[1] || 0;
            const lives0 = data.stats.livesDistribution[0] || 0;
            const totalPlayers = lives3 + lives2 + lives1 + lives0;

            // Trouver le joueur le plus rapide parmi les réponses correctes
            let fastestPlayer = null;
            if (data.players) {
                const correctPlayers = data.players.filter(p => p.isCorrect && p.responseTime);
                if (correctPlayers.length > 0) {
                    fastestPlayer = correctPlayers.reduce((fastest, current) => 
                        current.responseTime < fastest.responseTime ? current : fastest
                    );
                }
            }

            // Calculs pour les camemberts
            const circumference = 2 * Math.PI * 45;
            
            // Segments diagramme 1 (réponses)
            const correctPercent = totalAnswers > 0 ? correctCount / totalAnswers : 0;
            const wrongPercent = totalAnswers > 0 ? wrongCount / totalAnswers : 0;
            const afkPercent = totalAnswers > 0 ? afkCount / totalAnswers : 0;
            
            const correctDash = correctPercent * circumference;
            const wrongDash = wrongPercent * circumference;
            const afkDash = afkPercent * circumference;
            
            // Segments diagramme 2 (vies)
            const lives3Percent = totalPlayers > 0 ? lives3 / totalPlayers : 0;
            const lives2Percent = totalPlayers > 0 ? lives2 / totalPlayers : 0;
            const lives1Percent = totalPlayers > 0 ? lives1 / totalPlayers : 0;
            const lives0Percent = totalPlayers > 0 ? lives0 / totalPlayers : 0;
            
            const lives3Dash = lives3Percent * circumference;
            const lives2Dash = lives2Percent * circumference;
            const lives1Dash = lives1Percent * circumference;
            const lives0Dash = lives0Percent * circumference;

            container.innerHTML = `
                <div class="results-display">
                    <h3 class="results-question-text">${currentQuestionData?.question || "Question"}</h3>
                    
                    <div class="charts-container">
                        <!-- Diagramme 1: Répartition des réponses -->
                        <div class="chart-box">
                            <div class="chart-title">Répartition des réponses</div>
                            <div class="chart-with-legend">
                                <div class="chart-legend">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #00ff88;"></div>
                                        <span class="legend-label">✓</span>
                                        <span class="legend-value">${correctCount}</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ff4757;"></div>
                                        <span class="legend-label">✕</span>
                                        <span class="legend-value">${wrongCount}</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ffa502;"></div>
                                        <span class="legend-label">⏱</span>
                                        <span class="legend-value">${afkCount}</span>
                                    </div>
                                </div>
                                <svg id="answersChart" class="chart-svg" viewBox="0 0 100 100"></svg>
                            </div>
                        </div>

                        <!-- Diagramme 2: Répartition des vies -->
                        <div class="chart-box">
                            <div class="chart-title">Répartition des vies</div>
                            <div class="chart-with-legend">
                                <div class="chart-legend">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #00ff88;"></div>
                                        <span class="legend-label">❤️❤️❤️</span>
                                        <span class="legend-value">${lives3}</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #FFD700;"></div>
                                        <span class="legend-label">❤️❤️</span>
                                        <span class="legend-value">${lives2}</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ffa502;"></div>
                                        <span class="legend-label">❤️</span>
                                        <span class="legend-value">${lives1}</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ff4757;"></div>
                                        <span class="legend-label">💀</span>
                                        <span class="legend-value">${lives0}</span>
                                    </div>
                                </div>
                                <svg id="livesChart" class="chart-svg" viewBox="0 0 100 100"></svg>
                            </div>
                        </div>
                    </div>

                    ${fastestPlayer ? `
                        <div class="fastest-player">
                            <h4>⚡ Plus rapide:</h4>
                            <span class="fastest-player-name">${fastestPlayer.username}</span>
                            <span class="fastest-player-time">${(fastestPlayer.responseTime / 1000).toFixed(2)}s</span>
                        </div>
                    ` : ''}
                </div>
            `;

            // Afficher les résultats et cacher la question
            container.style.display = 'block';
            document.getElementById('questionContainer').style.display = 'none';

            // 🆕 Générer les charts APRÈS avoir affiché le container
            setTimeout(() => {
                if (totalAnswers > 0) {
                    const svg1 = document.getElementById('answersChart');
                    if (svg1) {
                        generatePieChart(svg1, [
                            { value: correctCount, color: '#00ff88', label: '✓\n' + correctCount },
                            { value: wrongCount, color: '#ff4757', label: '✕\n' + wrongCount },
                            { value: afkCount, color: '#ffa502', label: '⏱\n' + afkCount }
                        ]);
                    }
                } else {
                    const svg1 = document.getElementById('answersChart');
                    if (svg1) {
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', '50');
                        text.setAttribute('y', '50');
                        text.setAttribute('text-anchor', 'middle');
                        text.setAttribute('fill', '#fff');
                        text.setAttribute('font-size', '8');
                        text.textContent = 'Aucune réponse';
                        svg1.appendChild(text);
                    }
                }

                if (totalPlayers > 0) {
                    const svg2 = document.getElementById('livesChart');
                    if (svg2) {
                        generatePieChart(svg2, [
                            { value: lives3, color: '#00ff88', label: '3❤\n' + lives3 },
                            { value: lives2, color: '#FFD700', label: '2❤\n' + lives2 },
                            { value: lives1, color: '#ffa502', label: '1❤\n' + lives1 },
                            { value: lives0, color: '#ff4757', label: '💀\n' + lives0 }
                        ]);
                    }
                } else {
                    const svg2 = document.getElementById('livesChart');
                    if (svg2) {
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', '50');
                        text.setAttribute('y', '50');
                        text.setAttribute('text-anchor', 'middle');
                        text.setAttribute('fill', '#fff');
                        text.setAttribute('font-size', '8');
                        text.textContent = 'Aucun joueur';
                        svg2.appendChild(text);
                    }
                }
                
                console.log('✅ Charts injected successfully');
            }, 50);

            // Update stats - Actifs = joueurs restants après la question
            document.getElementById('activePlayers').textContent = data.remainingPlayers;
            
            // Mettre à jour la grille des joueurs avec les indicateurs de réponse
            if (data.playersData) {
                updatePlayersGridWithResults(data.playersData, data.players);
            }
            
            console.log('✅ Results displayed successfully');
        }

        // 🆕 Fonction pour générer un pie chart SVG avec labels (FIXED)
        function generatePieChart(svgElement, segments) {
            console.log('🎨 generatePieChart appelé avec:', segments);
            
            // Vider le SVG
            while (svgElement.firstChild) {
                svgElement.removeChild(svgElement.firstChild);
            }
            
            const centerX = 50;
            const centerY = 50;
            const radius = 40;
            let currentAngle = -90;
            
            // Filtrer les segments avec valeur > 0
            const validSegments = segments.filter(s => s.value > 0);
            
            console.log('✅ Valid segments:', validSegments);
            
            if (validSegments.length === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '50');
                text.setAttribute('y', '50');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', '8');
                text.textContent = 'Aucune donnée';
                svgElement.appendChild(text);
                return;
            }
            
            // Calculer le total
            const total = validSegments.reduce((sum, s) => sum + s.value, 0);
            console.log('📊 Total:', total);
            
            validSegments.forEach((segment, i) => {
                const angle = (segment.value / total) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;
                
                console.log(`Segment ${i}:`, { angle, startAngle, endAngle, color: segment.color });
                
                // Convertir en radians
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                // Points de départ et fin
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);
                
                const largeArc = angle > 180 ? 1 : 0;
                
                // ⭐ FIX: Pour un cercle complet (360°), utiliser 2 arcs de 180°
let pathD;
if (angle >= 359.9) {
    // Cercle complet : 2 demi-cercles
    const midX = centerX - radius;
    pathD = `M ${centerX},${centerY - radius} A ${radius},${radius} 0 0,1 ${centerX},${centerY + radius} A ${radius},${radius} 0 0,1 ${centerX},${centerY - radius} Z`;
} else {
    pathD = `M ${centerX},${centerY} L ${x1},${y1} A ${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z`;
}
console.log('Path:', pathD);

// ⭐ CRÉER LE PATH AVEC createElementNS
const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
path.setAttribute('d', pathD);
path.setAttribute('fill', segment.color);
path.setAttribute('stroke', '#1a1d29');
path.setAttribute('stroke-width', '1.5');
svgElement.appendChild(path);
                
                currentAngle = endAngle;
            });
            
            console.log('✅ SVG elements created successfully');
        }

        function hideResults() {
            console.log('🔄 Hiding results, showing question');
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('resultsContainer').innerHTML = ''; // Vider le contenu
            document.getElementById('questionContainer').style.display = 'block';
        }

        // 🆕 Reset l'affichage à l'état initial
        function resetQuestionDisplay() {
            console.log('🔄 Reset question display');
            const questionContainer = document.getElementById('questionContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Cacher les résultats
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            
            // Afficher le message par défaut
            questionContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">❓</div>
                    <h3>Aucune question active</h3>
                    <p>Démarrez une partie pour afficher les questions</p>
                </div>
            `;
            questionContainer.style.display = 'block';
            
            // Revenir à l'onglet Question
            switchTab('question');
        }

        // ============ GAME END PANEL ============
        function displayGameEnd(data) {
            console.log('🏁 Affichage fin de partie:', data);
            
            const resultsContainer = document.getElementById('resultsContainer');
            const questionContainer = document.getElementById('questionContainer');
            
            // Cacher la question et afficher le panel de fin
            questionContainer.style.display = 'none';
            
            if (!data.winner) {
                resultsContainer.innerHTML = `
                    <div class="game-end-panel">
                        <div class="game-end-header">
                            <h2>Partie terminée</h2>
                        </div>
                        <p>Aucun gagnant</p>
                    </div>
                `;
            } else {
                // Panel avec le gagnant
                const hearts = '❤️'.repeat(data.winner.livesRemaining);
                
                resultsContainer.innerHTML = `
                    <div class="game-end-panel">
                        <div class="game-end-header">
                            <h2>Partie terminée !</h2>
                        </div>
                        
                        <div class="winner-section">
                            <div class="winner-badge">VAINQUEUR</div>
                            <div class="winner-name">${data.winner.username}</div>
                            
                            <div class="winner-stats">
                                <div class="winner-stat">
                                    <div class="stat-label">Vies restantes</div>
                                    <div class="stat-value hearts">${hearts}</div>
                                </div>
                                <div class="stat-divider"></div>
                                <div class="winner-stat">
                                    <div class="stat-label">Victoires totales</div>
                                    <div class="stat-value">${data.winner.totalVictories}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="game-summary">
                            <div class="summary-item">
                                <span class="summary-label">Questions</span>
                                <span class="summary-value">${data.totalQuestions}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Durée</span>
                                <span class="summary-value">${Math.floor(data.duration / 60)}m ${data.duration % 60}s</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.style.display = 'block';
        }

        // ============ PLAYERS GRID ============
        function updatePlayersGrid(players) {
            const grid = document.getElementById('playersGrid');
            
            if (players.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>Aucun joueur</h3>
                        <p>Les joueurs apparaîtront ici une fois la partie lancée</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = players.map(player => {
                const isEliminated = player.lives === 0;
                const statusClass = player.lastAnswerCorrect === true ? 'correct' : 
                                  player.lastAnswerCorrect === false ? 'wrong' : '';

                return `
                    <div class="player-card ${statusClass} ${isEliminated ? 'eliminated' : ''}">
                        <div class="player-header">
                            <div class="player-username">${player.username}</div>
                            <div class="player-status">
                                <div class="status-indicator ${statusClass}"></div>
                            </div>
                        </div>
                        <div class="player-lives">
                            <span>Vies:</span>
                            ${[1, 2, 3].map(n => 
                                `<span class="heart-icon ${n <= player.lives ? 'active' : 'lost'}">
                                    ${n <= player.lives ? '❤️' : '🖤'}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 🆕 Mettre à jour la grille avec les résultats de la question
        function updatePlayersGridWithResults(playersData, playersDetails) {
            const grid = document.getElementById('playersGrid');
            
            if (!playersData || playersData.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>Aucun joueur</h3>
                        <p>Les joueurs apparaîtront ici une fois la partie lancée</p>
                    </div>
                `;
                return;
            }

            // Créer une map des détails pour accès rapide
            const detailsMap = new Map();
            if (playersDetails) {
                playersDetails.forEach(detail => {
                    detailsMap.set(detail.username, detail);
                });
            }

            grid.innerHTML = playersData.map(player => {
                const isEliminated = player.lives === 0;
                const detail = detailsMap.get(player.username);
                const statusClass = detail?.isCorrect ? 'correct' : 
                                  detail?.isCorrect === false ? 'wrong' : '';

                return `
                    <div class="player-card ${statusClass} ${isEliminated ? 'eliminated' : ''}">
                        <div class="player-header">
                            <div class="player-username">${player.username}</div>
                            <div class="player-status">
                                <div class="status-indicator ${statusClass}"></div>
                            </div>
                        </div>
                        <div class="player-lives">
                            <span>Vies:</span>
                            ${[1, 2, 3].map(n => 
                                `<span class="heart-icon ${n <= player.lives ? 'active' : 'lost'}">
                                    ${n <= player.lives ? '❤️' : '🖤'}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ OVERLAYS ============
        function toggleOverlay(type) {
            closeOverlays();
            
            const backdrop = document.getElementById('overlayBackdrop');
            backdrop.classList.add('active');

            if (type === 'top10') {
                document.getElementById('overlayTop10').classList.add('active');
            } else if (type === 'recent') {
                document.getElementById('overlayRecent').classList.add('active');
            }
        }

        function closeOverlays() {
            document.getElementById('overlayBackdrop').classList.remove('active');
            document.getElementById('overlayTop10').classList.remove('active');
            document.getElementById('overlayRecent').classList.remove('active');
        }

        // ============ TABS ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            if (tab === 'question') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tabQuestion').classList.add('active');
            } else if (tab === 'players') {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tabPlayers').classList.add('active');
            }
        }

        // ============ ACTIONS ============
        async function toggleGame() {
            // 🆕 Anti-spam
            if (isTogglingGame) {
                console.log('⏳ Veuillez patienter...');
                return;
            }
            
            isTogglingGame = true;
            
            try {
                const response = await fetch('/admin/toggle-game', { 
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                if (response.status === 403) {
                    if (!isReloading) {
                        isReloading = true;
                        console.log('⚠️ Session expirée, rechargement...');
                        location.reload();
                    }
                    return;
                }
                
                if (!response.ok) {
                    console.error('❌ Erreur toggle-game:', response.status);
                    return;
                }
                
                const data = await response.json();
                updateGameStatus(data.isActive);
                
                // 🆕 Si on ouvre le lobby, reset l'affichage de fin de partie
                if (data.isActive) {
                    resetQuestionDisplay();
                    toggleSettingsAccess(true); // Débloquer les paramètres
                }
                
                refreshStats();
            } catch (error) {
                console.error('❌ Erreur toggleGame:', error);
            } finally {
                // 🆕 Débloquer après 1 seconde
                setTimeout(() => {
                    isTogglingGame = false;
                }, 1000);
            }
        }

        async function startGame() {
            // 🆕 Anti-spam
            if (isStartingGame) {
                console.log('⏳ Démarrage en cours...');
                return;
            }
            
            isStartingGame = true;
            
            try {
                const response = await fetch('/admin/start-game', { 
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                if (response.status === 403) {
                    if (!isReloading) {
                        isReloading = true;
                        console.log('⚠️ Session expirée, rechargement...');
                        location.reload();
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    toggleSettingsAccess(false); // Bloquer les paramètres
                    refreshStats();
                }
            } catch (error) {
                console.error('Erreur démarrage:', error);
            } finally {
                // 🆕 Débloquer après 2 secondes
                setTimeout(() => {
                    isStartingGame = false;
                }, 2000);
            }
        }

        async function nextQuestion() {
            const nextCard = document.getElementById('nextQuestionCard');
            
            // 🆕 Anti-spam
            if (isNextQuestion) {
                console.log('⏳ Question en cours d\'envoi...');
                return;
            }
            
            isNextQuestion = true;
            
            // 🆕 Ajouter l'état visuel de blocage
            nextCard.classList.add('timer-blocked');
            nextCard.classList.remove('game-active');
            
            try {
                const response = await fetch('/admin/next-question', { 
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                if (response.status === 403) {
                    if (!isReloading) {
                        isReloading = true;
                        console.log('⚠️ Session expirée, rechargement...');
                        location.reload();
                    }
                    return;
                }
                
                if (!response.ok) {
                    const data = await response.json();
                    
                    // 🆕 Si bloqué par le timer (400 avec blocked: true)
                    if (response.status === 400 && data.blocked) {
                        console.log(`⏱ Timer actif - ${data.timeRemaining}s restantes`);
                        // Garder le visuel bloqué pendant le temps restant
                        setTimeout(() => {
                            nextCard.classList.remove('timer-blocked');
                            nextCard.classList.add('game-active');
                            isNextQuestion = false;
                        }, data.timeRemaining * 1000);
                        return;
                    }
                    
                    console.error('❌ Erreur next-question:', response.status);
                    nextCard.classList.remove('timer-blocked');
                    nextCard.classList.add('game-active');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    console.log('✅ Question suivante envoyée');

                    // 🆕 Switch automatique vers l'onglet "Question en cours"
                    switchTab('question');
                    // 🆕 Garder le visuel bloqué pendant 7 secondes (durée du timer)
                    setTimeout(() => {
                        nextCard.classList.remove('timer-blocked');
                        nextCard.classList.add('game-active');
                        isNextQuestion = false;
                    }, 7000);
                }
            } catch (error) {
                console.error('❌ Erreur nextQuestion:', error);
                nextCard.classList.remove('timer-blocked');
                nextCard.classList.add('game-active');
                isNextQuestion = false;
            }
        }

        // ============ GAME SETTINGS ============
        function setLives(lives) {
            if (isGameInProgress()) return;
            
            gameSettings.lives = lives;
            
            // Update UI
            document.querySelectorAll('.lives-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lives-${lives}`).classList.add('active');
            
            // 🆕 Utiliser la route spécifique /admin/set-lives
            fetch('/admin/set-lives', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ lives: lives })
            }).then(response => response.json())
            .then(data => console.log('✅ Vies synchronisées:', data))
            .catch(err => console.error('❌ Erreur sync vies:', err));
            
            console.log(`✅ Vies définies: ${lives}`);
        }

        function setTime(seconds) {
            if (isGameInProgress()) return;
            
            gameSettings.timePerQuestion = parseInt(seconds);
            
            // 🆕 Émettre vers le serveur pour synchroniser avec les clients
            fetch('/admin/update-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ lives: gameSettings.lives, timePerQuestion: gameSettings.timePerQuestion })
            }).then(response => response.json())
            .then(data => console.log('✅ Paramètres synchronisés'))
            .catch(err => console.error('❌ Erreur sync paramètres:', err));
            
            console.log(`✅ Temps défini: ${seconds}s`);
        }

        function setAnswers(count) {
            if (isGameInProgress()) return;
            
            gameSettings.answersCount = count;
            
            // Update UI
            document.querySelectorAll('#answers-4, #answers-6').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`answers-${count}`).classList.add('active');
            
            // Envoyer au serveur
            fetch('/admin/set-answers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ answers: count })
            }).then(response => response.json())
            .then(data => console.log('✅ Nombre de réponses synchronisé:', data))
            .catch(err => console.error('❌ Erreur sync réponses:', err));
            
            console.log(`✅ Réponses définies: ${count}`);
        }

        function isGameInProgress() {
            // Check if game is in progress (disable settings)
            const startCard = document.getElementById('startGameCard');
            return !startCard.classList.contains('game-active') && 
                   !startCard.classList.contains('disabled');
        }

        function toggleSettingsAccess(enabled) {
            const settingsSection = document.getElementById('gameSettings');
            const livesButtons = document.querySelectorAll('.lives-btn');
            const timeSelect = document.getElementById('timeSelect');
            
            if (enabled) {
                settingsSection.classList.remove('disabled');
                livesButtons.forEach(btn => btn.disabled = false);
                timeSelect.disabled = false;
            } else {
                settingsSection.classList.add('disabled');
                livesButtons.forEach(btn => btn.disabled = true);
                timeSelect.disabled = true;
            }
        }

        // ============ DATABASE STATS ============
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/admin/db-stats', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    console.error('❌ Erreur chargement stats DB');
                    return;
                }
                
                const stats = await response.json();
                
                // Vérifier que les éléments existent avant de les modifier
                const dbTotalQuestions = document.getElementById('dbTotalQuestions');
                const dbTotalSeries = document.getElementById('dbTotalSeries');
                const dbVeryEasy = document.getElementById('dbVeryEasy');
                const dbEasy = document.getElementById('dbEasy');
                const dbMedium = document.getElementById('dbMedium');
                const dbHard = document.getElementById('dbHard');
                const dbVeryHard = document.getElementById('dbVeryHard');
                
                if (dbTotalQuestions) dbTotalQuestions.textContent = stats.totalQuestions;
                if (dbTotalSeries) dbTotalSeries.textContent = stats.totalSeries;
                if (dbVeryEasy) dbVeryEasy.textContent = stats.byDifficulty.veryeasy || 0;
                if (dbEasy) dbEasy.textContent = stats.byDifficulty.easy || 0;
                if (dbMedium) dbMedium.textContent = stats.byDifficulty.medium || 0;
                if (dbHard) dbHard.textContent = stats.byDifficulty.hard || 0;
                if (dbVeryHard) dbVeryHard.textContent = stats.byDifficulty.veryhard || 0;
                
                console.log('✅ Stats DB chargées:', stats);
            } catch (error) {
                console.error('❌ Erreur loadDatabaseStats:', error);
            }
        }
        function refreshPage() {
            location.reload();
        }

        async function refreshStats() {
            try {
                const response = await fetch('/admin/stats', {
                    credentials: 'same-origin'
                });
                
                if (response.status === 403) {
                    if (!isReloading) {
                        isReloading = true;
                        console.log('⚠️ Session expirée, rechargement...');
                        clearInterval(statsInterval); // 🆕 Arrêter le refresh avant de recharger
                        location.reload();
                    }
                    return;
                }
                
                if (!response.ok) {
                    console.error('❌ Erreur refresh stats:', response.status);
                    return;
                }
                
                const data = await response.json();

                // 🆕 Récupérer l'état du jeu pour le timer
                const gameStateResponse = await fetch('/game/state', {
                    credentials: 'same-origin'
                });
                const gameState = await gameStateResponse.json();

                document.getElementById('totalGames').textContent = data.totalGames;
                
                // 🆕 Logique Lobby vs Actifs
                if (data.gameInProgress) {
                    // Partie en cours : Lobby = 0, Actifs = joueurs en vie
                    document.getElementById('playerCount').textContent = '0';
                    document.getElementById('activePlayers').textContent = data.activePlayers;
                } else {
                    // Avant/après partie : Lobby = joueurs qui rejoignent, Actifs = 0
                    document.getElementById('playerCount').textContent = data.currentPlayers;
                    document.getElementById('activePlayers').textContent = '0';
                }

                updateGameStatus(data.gameActive);

                const startCard = document.getElementById('startGameCard');
                const nextCard = document.getElementById('nextQuestionCard');
                
                if (!data.gameActive || data.gameInProgress || data.currentPlayers === 0) {
                    startCard.classList.add('disabled');
                    startCard.classList.remove('game-active');
                } else {
                    startCard.classList.remove('disabled');
                    startCard.classList.add('game-active'); // 🆕 Indicateur visuel
                }

                if (!data.gameInProgress) {
                    nextCard.classList.add('disabled');
                    nextCard.classList.remove('game-active');
                    nextCard.classList.remove('timer-blocked'); // 🆕 Retirer timer-blocked
                } else {
                    nextCard.classList.remove('disabled');
                    
                    // 🆕 Gérer l'état timer-blocked si une question est en cours
                    if (gameState.timeRemaining !== null && gameState.timeRemaining > 0) {
                        nextCard.classList.add('timer-blocked');
                        nextCard.classList.remove('game-active');
                        isNextQuestion = true;
                        
                        // Débloquer après le temps restant
                        setTimeout(() => {
                            nextCard.classList.remove('timer-blocked');
                            nextCard.classList.add('game-active');
                            isNextQuestion = false;
                        }, gameState.timeRemaining * 1000);
                    } else {
                        nextCard.classList.remove('timer-blocked');
                        nextCard.classList.add('game-active');
                    }
                }

                const topPlayersTable = document.getElementById('topPlayersTable');
                if (data.topPlayers.length === 0) {
                    topPlayersTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">Aucune donnée disponible</td></tr>';
                } else {
                    topPlayersTable.innerHTML = data.topPlayers.map((player, index) => `
                        <tr>
                            <td><span class="rank-badge rank-${index + 1}">${index + 1}</span></td>
                            <td>${player.username}</td>
                            <td>${player.total_victories}</td>
                            <td>${player.total_games_played}</td>
                        </tr>
                    `).join('');
                }

                const recentGamesTable = document.getElementById('recentGamesTable');
                if (data.recentGames.length === 0) {
                    recentGamesTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">Aucune donnée disponible</td></tr>';
                } else {
                    recentGamesTable.innerHTML = data.recentGames.map(game => `
                        <tr>
                            <td>#${game.id}</td>
                            <td>${game.winner ? game.winner.username : 'N/A'}</td>
                            <td>${game.questions_count}</td>
                            <td>${new Date(game.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        function updateGameStatus(isActive) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            const toggleBtn = document.getElementById('toggleGameBtn');
            const toggleCard = document.getElementById('toggleGameCard');

            if (isActive) {
                statusText.textContent = 'ACTIF';
                statusIndicator.classList.remove('inactive');
                statusIndicator.classList.add('active');
                toggleBtn.textContent = 'Fermer lobby';
                toggleCard.classList.add('lobby-active');
            } else {
                statusText.textContent = 'INACTIF';
                statusIndicator.classList.remove('active');
                statusIndicator.classList.add('inactive');
                toggleBtn.textContent = 'Ouvrir lobby';
                toggleCard.classList.remove('lobby-active');
            }
        }

        function startStatsRefresh() {
            statsInterval = setInterval(refreshStats, 3000);
        }


        // Gestion du formulaire d'ajout de question
        document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const statusDiv = document.getElementById('addQuestionStatus');
            statusDiv.style.display = 'none';
            
            const formData = {
                question: document.getElementById('questionText').value,
                answer1: document.getElementById('answer1').value,
                answer2: document.getElementById('answer2').value,
                answer3: document.getElementById('answer3').value,
                answer4: document.getElementById('answer4').value,
                answer5: document.getElementById('answer5').value,
                answer6: document.getElementById('answer6').value,
                correctAnswer: document.getElementById('correctAnswer').value,
                serie: document.getElementById('serie').value,
                difficulty: document.getElementById('difficulty').value
            };
            
            try {
                const response = await fetch('/admin/add-question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.textContent = '✅ Question ajoutée avec succès !';
                    statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                    statusDiv.style.color = '#10b981';
                    statusDiv.style.border = '1px solid #10b981';
                    statusDiv.style.display = 'block';
                    
                    // Reset form
                    document.getElementById('addQuestionForm').reset();
                    
                    // Refresh DB stats
                    loadDatabaseStats();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                statusDiv.textContent = '❌ Erreur: ' + error.message;
                statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                statusDiv.style.color = '#ef4444';
                statusDiv.style.border = '1px solid #ef4444';
                statusDiv.style.display = 'block';
            }
        });

        // ============ INIT ============
        checkAuth();
        loadDatabaseStats(); // Charger les stats DB au démarrage
    </script>
</body>
</html>

