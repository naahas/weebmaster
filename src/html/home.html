<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShonenMaster - Quiz Anime Tournoi</title>
    <link rel="stylesheet" href="home.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Theme Toggle -->
        <div class="theme-toggle" @click="toggleTheme">
            <div class="toggle-icon">{{ isDark ? '‚òÄÔ∏è' : 'üåô' }}</div>
        </div>

        <!-- Particles Background -->
        <div id="particles-js"></div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Logo & Title (Non connect√© et jeu non actif) -->
            <div class="header-section welcome-screen" v-if="!isAuthenticated && !gameInProgress">
                <h1 class="logo-title">
                    <span class="neon-text">Shonen</span><span class="neon-text-alt">Master</span>
                </h1>
                
                <button class="btn-primary btn-twitch floating" @click="loginTwitch">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
                    </svg>
                    <span>Se connecter avec Twitch</span>
                </button>
            </div>

            <!-- Logo simplifi√© (Utilisateur authentifi√© uniquement) -->
            <div class="header-section" v-if="isAuthenticated && !gameInProgress">
                <h1 class="logo-title">
                    <!-- <span class="neon-text">Shonen</span><span class="neon-text-alt">Master</span> -->
                </h1>
                <div class="live-badge" v-if="isGameActive">
                    <span class="pulse-dot"></span>
                    <span>EN LIVE</span>
                </div>
            </div>

            <!-- √âtat: Connect√© mais jeu non activ√© -->
            <div class="content-section" v-if="!isGameActive && isAuthenticated">
                <div class="info-card">
                    <div class="user-welcome">
                        <div class="avatar-icon">üë§</div>
                        <div>
                            <p class="welcome-text">Bienvenue,</p>
                            <h3 class="username">{{ username }}</h3>
                        </div>
                    </div>
                    
                    <div class="separator"></div>
                    
                    <h2>En pr√©paration...</h2>
                    <p>La partie commence bient√¥t !</p>
                    <p class="small-text">Restez connect√©, le lobby ouvrira sous peu.</p>
                </div>

                <button class="btn-secondary" @click="logout">
                    D√©connexion
                </button>
            </div>

            <!-- √âtat: Lobby (jeu activ√©, en attente) -->
            <div class="content-section" v-if="isGameActive && !gameInProgress && !gameStartedOnServer && isAuthenticated">
                <div class="lobby-card">
                    <div class="lobby-header">
                        <h2>La partie va commencer...</h2>
                    </div>

                    <div class="lobby-stats">
                        <div class="stat-box">
                            <div class="stat-number">{{ playerCount }}</div>
                            <div class="stat-label">Joueurs dans la file</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">3</div>
                            <div class="stat-label">Vies</div>
                        </div>
                    </div>

                    <button class="btn-primary btn-join" @click="joinLobby" :disabled="hasJoined">
                        {{ hasJoined ? '‚úì Vous √™tes dans la partie !' : 'Rejoindre la partie' }}
                    </button>
                </div>

                <button class="btn-secondary" @click="logout">
                    D√©connexion
                </button>
            </div>

            <!-- √âtat: Spectateur (partie en cours mais pas rejoint) -->
            <div class="content-section" v-if="gameStartedOnServer && !gameInProgress && isGameActive && isAuthenticated">
                <div class="info-card spectator-card">
                    <div class="spectator-icon">‚è≥</div>
                    <h2>Partie en cours</h2>
                    <p>Une partie est actuellement en cours.</p>
                    <p class="small-text">Veuillez patienter jusqu'√† la prochaine partie pour rejoindre le jeu.</p>
                </div>

                <button class="btn-secondary" @click="logout">
                    D√©connexion
                </button>
            </div>

            <!-- √âtat: Partie en cours -->
            <div class="content-section game-section" v-if="gameInProgress && isAuthenticated && !gameEnded">
                <!-- HUD du joueur -->
                <div class="player-hud">
                    <div class="hud-item">
                        <span class="hud-label">Joueur</span>
                        <span class="hud-value">{{ username }}</span>
                    </div>
                    <div class="hud-item lives-display">
                        <span class="hud-label">Vies</span>
                        <div class="hearts">
                            <span v-for="n in 3" :key="n" class="heart" :class="{ lost: n > playerLives }">
                                {{ n <= playerLives ? '‚ù§Ô∏è' : 'üñ§' }}
                            </span>
                        </div>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">Question</span>
                        <span class="hud-value">{{ currentQuestionNumber }}</span>
                    </div>
                </div>
                
                <!-- üÜï Conteneur fixe pour √©viter d√©calages -->
                <div class="question-container-wrapper">
                    <!-- üÜï Barre de timer horizontale ultra-fine (toujours pr√©sente pour √©viter les d√©calages) -->
                    <div class="timer-bar-container" :class="{ hidden: !currentQuestion || showResults }">
                        <div 
                            class="timer-bar-progress" 
                            :style="{ width: timerProgress + '%' }"
                            :class="{ warning: timeRemaining <= 3 }"
                        ></div>
                    </div>

                    <!-- Question -->
                    <div class="question-card" v-if="currentQuestion && !showResults">
                    <!-- Badges s√©rie et difficult√© -->
                    <div class="question-badges">
                        <span class="serie-badge">{{ currentQuestion.serie }}</span>
                        <span class="difficulty-badge" :class="'diff-' + currentQuestion.difficulty">
                            {{ currentQuestion.difficulty.toUpperCase() }}
                        </span>
                    </div>

                    <!-- Question -->
                    <h3 class="question-text">{{ currentQuestion.question }}</h3>

                    <!-- R√©ponses -->
                    <div class="answers-grid">
                        <button 
                            v-for="(answer, index) in currentQuestion.answers" 
                            :key="index"
                            class="answer-btn"
                            :class="{ selected: selectedAnswer === index + 1, disabled: hasAnswered || playerLives === 0 }"
                            @click="selectAnswer(index + 1)"
                            :disabled="hasAnswered || playerLives === 0"
                        >
                            <span class="answer-number">{{ index + 1 }}</span>
                            <span class="answer-text">{{ answer }}</span>
                        </button>
                    </div>

                    <div class="answer-status" v-if="hasAnswered">
                        <div class="status-icon">‚úì</div>
                        <p>R√©ponse enregistr√©e !</p>
                    </div>

                    <div class="eliminated-notice" v-if="playerLives === 0">
                        <div class="skull-icon">üíÄ</div>
                        <h3>Vous √™tes √©limin√©</h3>
                        <p>Vous pouvez continuer √† regarder la partie</p>
                    </div>
                </div>

                <!-- üÜï R√âSULTATS - Question avec indicateurs visuels -->
                <div class="question-card results-view" v-if="showResults && currentQuestion">
                    <!-- Badges s√©rie et difficult√© -->
                    <div class="question-badges">
                        <span class="serie-badge">{{ currentQuestion.serie }}</span>
                        <span class="difficulty-badge" :class="'diff-' + currentQuestion.difficulty">
                            {{ currentQuestion.difficulty.toUpperCase() }}
                        </span>
                    </div>

                    <!-- Question -->
                    <h3 class="question-text">{{ currentQuestion.question }}</h3>

                    <!-- R√©ponses avec indicateurs -->
                    <div class="answers-grid">
                        <div 
                            v-for="(answer, index) in currentQuestion.answers" 
                            :key="index"
                            class="answer-btn result-answer"
                            :class="{ 
                                'correct': (index + 1) === questionResults.correctAnswer,
                                'wrong': selectedAnswer === (index + 1) && selectedAnswer !== questionResults.correctAnswer,
                                'unselected': selectedAnswer && selectedAnswer !== (index + 1) && (index + 1) !== questionResults.correctAnswer
                            }"
                        >
                            <span class="answer-text">{{ answer }}</span>
                            <span class="result-icon" v-if="(index + 1) === questionResults.correctAnswer">‚úì</span>
                            <span class="result-icon wrong-icon" v-if="selectedAnswer === (index + 1) && selectedAnswer !== questionResults.correctAnswer">‚úï</span>
                        </div>
                    </div>

                    <!-- Stats discr√®tes en bas -->
                    <div class="survivors-count">
                        üë§ {{ questionResults.remainingPlayers }} restants
                    </div>
                </div>
                </div><!-- Fin question-container-wrapper -->
            </div>

            <!-- üÜï GAME OVER AM√âLIOR√â (Bug 2 fix) -->
            <div class="content-section gameover-section" v-if="gameEnded">
                <div class="gameover-card-improved">
                    <div class="gameover-header">
                        <h2>Partie termin√©e</h2>
                    </div>
                    
                    <div class="winner-section-improved" v-if="gameEndData.winner">
                        <div class="winner-label">Vainqueur</div>
                        <div class="winner-name-improved">{{ gameEndData.winner.username }}</div>
                        <div class="winner-stats">{{ gameEndData.winner.correctAnswers }} bonnes r√©ponses</div>
                    </div>

                    <div class="game-stats-improved">
                        <div class="stat-item-improved">
                            <div class="stat-value-improved">{{ gameEndData.totalQuestions }}</div>
                            <div class="stat-label-improved">Questions</div>
                        </div>
                        <div class="stat-divider"></div>
                        <div class="stat-item-improved">
                            <div class="stat-value-improved">{{ formatDuration(gameEndData.duration) }}</div>
                            <div class="stat-label-improved">Dur√©e</div>
                        </div>
                    </div>

                    <button class="btn-primary" @click="backToHome">
                        Retour √† l'accueil
                    </button>
                </div>
            </div>
        </div>
        
        <!-- üÜï Badge EN LIVE discret en bas (pour utilisateurs NON connect√©s) -->
        <div class="live-badge-bottom" v-if="isGameActive && !isAuthenticated && !gameInProgress">
            <span class="pulse-dot-small"></span>
            <span>EN LIVE</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="app.js"></script>
</body>
</html>