<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShonenMaster - Quiz Anime Tournoi</title>
    <link rel="stylesheet" href="home.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">

        <!-- Particles Background -->
        <div id="particles-js"></div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Logo & Title (Non connect√© et jeu non actif) -->
            <div class="header-section welcome-screen" v-if="!isAuthenticated && !gameInProgress">
                <h1 class="logo-title">
                    <span class="neon-text">Shonen</span><span class="neon-text-alt">Master</span>
                </h1>
                
                <button class="btn-primary btn-twitch floating" @click="loginTwitch">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
                    </svg>
                    <span>Se connecter avec Twitch</span>
                </button>
            </div>

            <!-- Logo simplifi√© (Utilisateur authentifi√© uniquement) -->
            <div class="header-section" v-if="isAuthenticated && !gameInProgress">
                <h1 class="logo-title">
                    <!-- <span class="neon-text">Shonen</span><span class="neon-text-alt">Master</span> -->
                </h1>
                <div class="live-badge" v-if="isGameActive">
                    <span class="pulse-dot"></span>
                    <span>EN LIVE</span>
                </div>
            </div>

            <!-- √âtat: Connect√© mais jeu non activ√© -->
            <div class="content-section" v-if="!isGameActive && isAuthenticated">
                <div class="info-card">
                    <div class="user-welcome">
                        <div class="avatar-icon">üë§</div>
                        <div>
                            <p class="welcome-text">Bienvenue,</p>
                            <h3 class="username">{{ username }}</h3>
                        </div>
                    </div>
                    
                    <div class="separator"></div>
                    
                    <h2>En pr√©paration...</h2>
                    <p>La partie commence bient√¥t !</p>
                    <p class="small-text">Restez connect√©, le lobby ouvrira sous peu.</p>
                </div>

                <button class="btn-secondary" @click="logout">
                    D√©connexion
                </button>
            </div>

            <!-- √âtat: Lobby (jeu activ√©, en attente) -->
            <div class="content-section" v-if="isGameActive && !gameInProgress && !gameStartedOnServer && isAuthenticated">
                <div class="lobby-card">
                    <div class="lobby-header">
                        <h2>La partie va commencer...</h2>
                    </div>

                    <div class="lobby-stats">
                        <div class="stat-box-single">
                            <div class="stat-content">
                                <div class="stat-number">{{ playerCount }}</div>
                                <!-- <div class="stat-icon">üë•</div> -->
                                <img src="people2.png" alt="Players" class="stat-icon-img">
                            </div>
                        </div>
                    </div>

                    <button class="btn-primary btn-join" @click="joinLobby" :disabled="hasJoined">
                        {{ hasJoined ? '‚úì Vous √™tes dans la partie !' : 'Rejoindre la partie' }}
                    </button>
                </div>

                <button class="btn-secondary" @click="logout">
                    D√©connexion
                </button>
            </div>

            <!-- √âtat: Spectateur (partie en cours mais pas rejoint) -->
            <div class="content-section" v-if="gameStartedOnServer && !gameInProgress && isGameActive && isAuthenticated">
                <div class="info-card spectator-card">
                    <div class="spectator-icon">‚è≥</div>
                    <h2>Partie en cours</h2>
                    <p>Une partie est actuellement en cours.</p>
                    <p class="small-text">Veuillez patienter jusqu'√† la prochaine partie pour rejoindre le jeu.</p>
                </div>

                <button class="btn-secondary" @click="logout">
                    D√©connexion
                </button>
            </div>

            <!-- √âtat: Partie en cours -->
            <div class="content-section game-section" v-if="gameInProgress && isAuthenticated && !gameEnded">
                <!-- HUD du joueur -->
                <div class="player-hud">
                    <div class="hud-item">
                        <span class="hud-label">Joueur</span>
                        <span class="hud-value">{{ username }}</span>
                    </div>
                    <div class="hud-item lives-display">
                        <span class="hud-label">Vies</span>
                        <div class="hearts">
                            <span v-for="n in 3" :key="n" class="heart" :class="{ lost: n > playerLives }">
                                {{ n <= playerLives ? '‚ù§Ô∏è' : 'üñ§' }}
                            </span>
                        </div>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">Question</span>
                        <span class="hud-value">{{ currentQuestionNumber }}</span>
                    </div>
                </div>
                
                <!-- üÜï Conteneur fixe pour √©viter d√©calages -->
                <div class="question-container-wrapper">
                    <!-- üÜï Barre de timer horizontale ultra-fine (toujours pr√©sente pour √©viter les d√©calages) -->
                    <div class="timer-bar-container" :class="{ hidden: !currentQuestion || showResults }">
                        <div 
                            class="timer-bar-progress" 
                            :style="{ width: timerProgress + '%' }"
                            :class="{ warning: timeRemaining <= 3 }"
                        ></div>
                    </div>

                    <!-- Question -->
                    <div class="question-card" v-if="currentQuestion && !showResults">
                    <!-- Badges s√©rie et difficult√© -->
                    <div class="question-badges">
                        <span class="serie-badge">{{ currentQuestion.serie }}</span>
                        <span class="difficulty-badge" :class="'diff-' + currentQuestion.difficulty">
                            {{ currentQuestion.difficulty.toUpperCase() }}
                        </span>
                    </div>

                    <!-- Question -->
                    <h3 class="question-text">{{ currentQuestion.question }}</h3>

                    <!-- R√©ponses -->
                    <div class="answers-grid" :class="{ 'grid-6': currentQuestion.answers.length === 6 }">
                        <button 
                            v-for="(answer, index) in currentQuestion.answers" 
                            :key="index"
                            class="answer-btn"
                            :class="{ selected: selectedAnswer === index + 1, disabled: hasAnswered || playerLives === 0 }"
                            @click="selectAnswer(index + 1)"
                            :disabled="hasAnswered || playerLives === 0"
                        >
                            <span class="answer-number">{{ index + 1 }}</span>
                            <span class="answer-text">{{ answer }}</span>
                        </button>
                    </div>

                    <div class="answer-status" v-if="hasAnswered">
                        <div class="status-icon">‚úì</div>
                        <p>R√©ponse enregistr√©e !</p>
                    </div>

                    <div class="eliminated-notice" v-if="playerLives === 0">
                        <div class="skull-icon">üíÄ</div>
                        <h3>Vous √™tes √©limin√©</h3>
                        <p>Vous pouvez continuer √† regarder la partie</p>
                    </div>
                </div>

                <!-- üÜï R√âSULTATS - Question avec indicateurs visuels -->
                <div class="question-card results-view" v-if="showResults && currentQuestion">
                    <!-- Badges s√©rie et difficult√© -->
                    <div class="question-badges">
                        <span class="serie-badge">{{ currentQuestion.serie }}</span>
                        <span class="difficulty-badge" :class="'diff-' + currentQuestion.difficulty">
                            {{ currentQuestion.difficulty.toUpperCase() }}
                        </span>
                    </div>

                    <!-- Question -->
                    <h3 class="question-text">{{ currentQuestion.question }}</h3>

                    <!-- R√©ponses avec indicateurs -->
                    <div class="answers-grid" :class="{ 'grid-6': currentQuestion.answers.length === 6 }">
                        <div 
                            v-for="(answer, index) in currentQuestion.answers" 
                            :key="index"
                            class="answer-btn result-answer"
                            :class="{ 
                                'correct': (index + 1) === questionResults.correctAnswer,
                                'wrong': selectedAnswer === (index + 1) && selectedAnswer !== questionResults.correctAnswer,
                                'unselected': selectedAnswer && selectedAnswer !== (index + 1) && (index + 1) !== questionResults.correctAnswer
                            }"
                        >
                            <span class="answer-text">{{ answer }}</span>
                            <span class="result-icon" v-if="(index + 1) === questionResults.correctAnswer">‚úì</span>
                            <span class="result-icon wrong-icon" v-if="selectedAnswer === (index + 1) && selectedAnswer !== questionResults.correctAnswer">‚úï</span>
                        </div>
                    </div>

                    <!-- Stats discr√®tes en bas -->
                    <div class="survivors-count">
                        üë§ {{ questionResults.remainingPlayers }} restants
                    </div>
                </div>
                </div><!-- Fin question-container-wrapper -->
            </div>

            <!-- üÜï GAME OVER AM√âLIOR√â (Bug 2 fix) -->
            <div class="content-section gameover-section" v-if="gameEnded">
                <div class="gameover-card-improved">
                    <div class="gameover-header">
                        <h2>Partie termin√©e</h2>
                    </div>
                    
                    <div class="winner-section-improved" v-if="gameEndData.winner">
                        <div class="winner-label">Vainqueur</div>
                        <div class="winner-name-improved">{{ gameEndData.winner.username }}</div>
                        <div class="winner-stats">{{ gameEndData.winner.correctAnswers }} bonnes r√©ponses</div>
                    </div>

                    <div class="game-stats-improved">
                        <div class="stat-item-improved">
                            <div class="stat-value-improved">{{ gameEndData.totalQuestions }}</div>
                            <div class="stat-label-improved">Questions</div>
                        </div>
                        <div class="stat-divider"></div>
                        <div class="stat-item-improved">
                            <div class="stat-value-improved">{{ formatDuration(gameEndData.duration) }}</div>
                            <div class="stat-label-improved">Dur√©e</div>
                        </div>
                    </div>

                    <button class="btn-primary" @click="backToHome">
                        Retour √† l'accueil
                    </button>
                </div>
            </div>
        </div>
        
        <!-- üÜï Badge EN LIVE discret en bas (pour utilisateurs NON connect√©s) -->
        <div class="live-badge-bottom" v-if="isGameActive && !isAuthenticated && !gameInProgress">
            <span class="pulse-dot-small"></span>
            <span>EN LIVE</span>
        </div>


        <!-- üÜï Bouton Profil (en haut √† droite, visible si connect√©) -->
        <button class="profile-btn" v-if="isAuthenticated" @click="openProfile">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </button>

        <!-- üÜï Modal Profil -->
        <div class="modal-overlay" v-if="showProfileModal" @click="closeProfile">
            <div class="modal-container" @click.stop>
                <div class="modal-header">
                    <h2>{{ username }}</h2>
                    <button class="modal-close" @click="closeProfile">‚úï</button>
                </div>

                <!-- Tabs -->
                <div class="modal-tabs">
                    <button 
                        class="tab-btn" 
                        :class="{ active: currentTab === 'profile' }"
                        @click="currentTab = 'profile'"
                    >
                        Profil
                    </button>
                    <button 
                        class="tab-btn" 
                        :class="{ active: currentTab === 'badges' }"
                        @click="currentTab = 'badges'"
                    >
                        Badges
                    </button>
                    <button 
                        class="tab-btn" 
                        :class="{ active: currentTab === 'titles' }"
                        @click="currentTab = 'titles'"
                    >
                        Titres
                    </button>
                </div>

                <!-- Tab Content: Profil -->
                <div class="modal-content" v-if="currentTab === 'profile' && profileData">
                    <div class="profile-stats">
                        <div class="current-title-badge">
                            <span class="title-label">Titre</span>
                            <span class="title-value">{{ profileData.titles.current.title_name }}</span>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-number">{{ profileData.user.total_games_played }}</span>
                                <span class="stat-label">Parties jou√©es</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">{{ profileData.user.total_victories }}</span>
                                <span class="stat-label">Victoires</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">{{ profileData.user.win_rate }}%</span>
                                <span class="stat-label">Win Rate</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Badges -->
                <div class="modal-content" v-if="currentTab === 'badges' && profileData">
                    <div class="badges-section">
                        <h3 class="section-title">üéÆ Parties jou√©es</h3>
                        <div class="badges-grid">
                            <div 
                                v-for="badge in profileData.badges.games_played" 
                                :key="'played-' + badge.tier"
                                class="badge-item"
                                :class="{ unlocked: badge.unlocked }"
                            >
                                <div class="badge-icon">
                                    {{ badge.unlocked ? 'üèÖ' : 'üîí' }}
                                </div>
                                <div class="badge-label">{{ badge.tier }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="badges-section">
                        <h3 class="section-title">üèÜ Parties gagn√©es</h3>
                        <div class="badges-grid">
                            <div 
                                v-for="badge in profileData.badges.games_won" 
                                :key="'won-' + badge.tier"
                                class="badge-item"
                                :class="{ unlocked: badge.unlocked }"
                            >
                                <div class="badge-icon">
                                    {{ badge.unlocked ? 'üëë' : 'üîí' }}
                                </div>
                                <div class="badge-label">{{ badge.tier }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Titres -->
                <div class="modal-content" v-if="currentTab === 'titles' && profileData">
                    <div class="titles-list">
                        <div 
                            v-for="title in profileData.titles.unlocked" 
                            :key="title.id"
                            class="title-item"
                            :class="{ equipped: title.id === profileData.titles.current.id }"
                            @click="equipTitle(title.id)"
                        >
                            <div class="title-info">
                                <span class="title-name">{{ title.title_name }}</span>
                                <span class="title-requirement">
                                    {{ title.requirement_value }} {{ title.title_type === 'games_played' ? 'parties' : 'victoires' }}
                                </span>
                            </div>
                            <span v-if="title.id === profileData.titles.current.id" class="equipped-badge">‚úì √âquip√©</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üÜï Bouton Toggle Leaderboard (mobile uniquement) -->
        <button class="leaderboard-toggle-btn" v-if="leaderboardLoaded && !isAuthenticated" @click="toggleLeaderboard">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path d="M7 7h10v2H7zm0 4h10v2H7zm0 4h10v2H7z"/>
                <path d="M12 3L4 9v12h16V9l-8-6zm6 16H6V10l6-4.5L18 10v9z"/>
            </svg>
        </button>

        <!-- üÜï Overlay sombre (mobile uniquement) -->
        <div class="leaderboard-overlay" :class="{ active: showLeaderboard }" @click="toggleLeaderboard" v-if="!isAuthenticated"></div>

        <!-- üÜï Leaderboard Panel (desktop toujours visible, mobile toggle) -->
        <div class="leaderboard-container" :class="{ 'mobile-open': showLeaderboard }" v-if="leaderboardLoaded && !isAuthenticated">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 class="leaderboard-title" style="margin-bottom: 0;">üèÜ Classement</h3>
                <button class="leaderboard-close-btn" @click="toggleLeaderboard">‚úï</button>
            </div>
            <div class="leaderboard-list">
                <div 
                    v-for="(player, index) in leaderboard" 
                    :key="player.twitch_id"
                    class="leaderboard-item"
                    :class="'rank-' + (index + 1)"
                >
                    <span class="rank">{{ index + 1 }}</span>
                    <div class="player-info">
                        <span class="player-name">{{ player.username }}</span>
                        <span class="player-title">{{ player.title_name }}</span>
                    </div>
                    <span class="player-winrate">{{ player.win_rate }}%</span>
                </div>
            </div>
        </div>



    </div>


    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="app.js"></script>
</body>
</html>